# 社群功能測試文檔

## 📋 測試概覽

本測試套件為紅樓慧讀平台的社群功能提供全面的測試覆蓋，包括：

### 🎯 測試範圍

#### 1. 社群服務測試 (`tests/lib/community-service.test.ts`)
- **預期使用情況**：正常的貼文、留言、按讚操作
- **邊界情況**：最小資料集、空結果處理
- **失敗情況**：網路錯誤、權限拒絕、無效資料

#### 2. React 組件測試 (`tests/app/community/`)
- **UI 渲染**：組件正確顯示
- **用戶互動**：按鈕點擊、表單提交
- **狀態管理**：載入中、錯誤狀態

#### 3. 整合測試
- **Firebase 連接**：資料庫操作完整流程
- **認證整合**：登入狀態與功能存取

## 🚀 運行測試

### 安裝依賴
```bash
npm install
```

### 運行所有測試
```bash
npm run test
```

### 運行特定測試
```bash
# 只運行社群服務測試
npm run test:community

# 運行測試並產生覆蓋率報告
npm run test:coverage

# 監控模式（開發時使用）
npm run test:watch
```

## 📊 測試組織結構

```
tests/
├── lib/
│   └── community-service.test.ts    # 社群服務單元測試
├── app/
│   └── community/
│       └── community-page.test.tsx  # 社群頁面組件測試
├── setup/
│   ├── global-setup.js              # 全局測試設定
│   └── global-teardown.js           # 全局測試清理
└── README.md                        # 本文檔
```

## 📈 測試輸出組織

每次測試運行都會在 `test-output/` 目錄中創建時間戳記資料夾：

```
test-output/
└── test-run-2024-01-15_10-30-45/
    ├── test-metadata.json           # 測試運行元資料
    ├── test-summary.json            # 測試結果摘要
    ├── community-service/           # 社群服務測試日誌
    │   ├── should_create_post_logs.json
    │   └── should_handle_errors_logs.json
    ├── community-page/              # 組件測試日誌
    ├── error-logs/                  # 錯誤日誌
    │   └── test-errors.json
    └── coverage-reports/            # 覆蓋率報告
```

## 🧪 測試案例說明

### 社群服務測試案例

#### ✅ 預期使用情況
1. **建立貼文成功** - 驗證正常貼文建立流程
2. **檢索貼文與篩選** - 驗證貼文查詢和搜尋功能
3. **新增留言** - 驗證留言功能和計數更新
4. **按讚/取消按讚** - 驗證互動功能

#### ⚠️ 邊界情況
1. **最小資料建立貼文** - 只有必填欄位的貼文
2. **空結果處理** - 沒有符合條件的查詢結果
3. **按讚系統邊界** - 重複按讚、取消不存在的讚

#### ❌ 失敗情況
1. **Firebase 連線失敗** - 網路中斷或權限問題
2. **無效資料驗證** - 缺少必填欄位或格式錯誤
3. **逾時處理** - 長時間無回應的網路請求

### React 組件測試案例

#### ✅ 預期使用情況
1. **認證用戶渲染** - 登入用戶看到完整介面
2. **貼文顯示** - 正確顯示從服務獲取的貼文
3. **新貼文建立** - 用戶可以成功發表新貼文

#### ⚠️ 邊界情況
1. **未認證用戶** - 未登入用戶看到登入提示
2. **空貼文狀態** - 沒有貼文時的空狀態顯示
3. **載入狀態** - 資料載入中的使用者體驗

#### ❌ 失敗情況
1. **網路錯誤** - 無法載入貼文時的錯誤處理
2. **發文失敗** - 貼文建立失敗的錯誤顯示
3. **搜尋無結果** - 搜尋沒有匹配結果的處理

## 🛠️ 測試工具與 Mock

### Firebase Mock
- **Firestore**：模擬資料庫操作
- **Authentication**：模擬用戶認證狀態
- **Timestamp**：模擬時間戳記處理

### React Testing Library
- **渲染測試**：組件渲染驗證
- **用戶互動**：模擬點擊、輸入等操作
- **異步等待**：等待狀態更新和 DOM 變化

### 自定義測試工具
- **testUtils.createMockDoc**：建立模擬 Firestore 文檔
- **testUtils.createMockUser**：建立模擬用戶物件
- **testUtils.createMockTimestamp**：建立模擬時間戳記

## 📝 測試最佳實踐

### 1. 測試結構
- **Arrange**：設定測試資料和 mock
- **Act**：執行待測試的功能
- **Assert**：驗證預期結果

### 2. 命名慣例
- 描述性測試名稱，說明測試的具體行為
- 使用 `should` 開頭描述預期行為
- 包含測試場景和預期結果

### 3. 錯誤處理
- 每個測試都有詳細的日誌記錄
- 錯誤情況要有明確的錯誤訊息驗證
- 包含異常情況的測試覆蓋

### 4. 效能考量
- 測試運行時間監控
- 大資料集的效能測試
- 記憶體使用量檢查

## 🔧 故障排除

### 常見問題

#### 1. TypeScript 錯誤
```bash
# 確保類型定義已安裝
npm install --save-dev @types/jest @types/testing-library__jest-dom
```

#### 2. Firebase Mock 問題
```bash
# 檢查 jest.setup.js 中的 mock 配置
# 確保所有 Firebase 函數都有對應的 mock
```

#### 3. 測試逾時
```bash
# 增加測試逾時時間（在 jest.config.js 中）
testTimeout: 30000
```

## 📊 覆蓋率目標

- **函數覆蓋率**：≥ 70%
- **行覆蓋率**：≥ 70%
- **分支覆蓋率**：≥ 70%
- **語句覆蓋率**：≥ 70%

## 🎯 持續改進

### 定期檢查
1. **每週**：檢查測試覆蓋率報告
2. **每月**：更新測試案例以涵蓋新功能
3. **每季**：檢視和重構測試結構

### 測試維護
1. **新功能**：必須包含對應的測試案例
2. **Bug 修復**：添加回歸測試
3. **重構**：更新相關測試案例

---

*最後更新：2024年1月15日* 