# 11/25 上線前工作包清單

**建立日期：** 2025-11-19 (週三)
**目標完成日：** 2025-11-25 (週二)
**工作天數：** 5 天 (11/19-11/25，假設週末不計入則為 4 天)

---

## Phase 1: 系統基礎與效能優化

### [ ] **Task 1.1**: 頁面編譯效能優化
- **Task Name**: 提升每頁編譯效率至 3-5 秒內完成
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 目前頁面載入時間過長，影響使用者體驗，需要優化 Next.js 編譯與載入效能
    - How:
        1. 分析現有頁面載入瓶頸 (使用 Next.js 內建分析工具)
        2. 實施代碼分割 (code splitting) 優化
        3. 延遲載入非關鍵元件 (lazy loading)
        4. 優化圖片與靜態資源載入
        5. 檢查並減少不必要的 API 呼叫
- **Resources Required**:
    - Materials: Next.js 效能優化文檔、Lighthouse 分析工具
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/` 下各頁面元件
        - `next.config.js` 配置檔
        - Next.js 官方效能優化指南
- **Deliverables**:
    - [ ] 完成頁面載入時間基準測試
    - [ ] 實施 lazy loading 優化
    - [ ] 頁面首次載入時間降至 3-5 秒內
    - [ ] 效能測試報告
- **Dependencies**: 無
- **Constraints**: 需要測試所有主要頁面的載入效能
- **Completion Status**: 未開始
- **Notes**: 優先處理最常使用的頁面 (閱讀頁面、社群頁面)

---

### [ ] **Task 1.2**: Loading 動畫效果修復
- **Task Name**: 修復 logo 旁的 loading 載入循環動畫
- **Estimated completed time**: 2-3 小時
- **Work Description**:
    - Why: 目前 loading 畫面只顯示白色邊框，未呈現預期的載入循環動畫效果
    - How:
        1. 檢查現有 loading 元件的 CSS 動畫定義
        2. 確認動畫關鍵幀 (keyframes) 正確設定
        3. 調整動畫樣式，確保圓形旋轉效果
        4. 測試各頁面的 loading 狀態
- **Resources Required**:
    - Materials: CSS 動畫參考、設計規格
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/components/ui/` 下的 loading 相關元件
        - Tailwind CSS 動畫類別
- **Deliverables**:
    - [ ] 修復 loading 動畫 CSS
    - [ ] 確認 logo 旁有明顯的圓形旋轉動畫
    - [ ] 各頁面 loading 效果一致性測試
- **Dependencies**: 無
- **Constraints**: 需保持與現有設計風格一致
- **Completion Status**: 未開始
- **Notes**: 可參考常見的 spinner 動畫實作

---

### [ ] **Task 1.3**: 主頁 UI 佈局修復
- **Task Name**: 修復主頁右滑 scroll bar 時 UI 跑版問題
- **Estimated completed time**: 3-4 小時
- **Work Description**:
    - Why: 當使用者水平滾動時，主頁 UI 佈局會跑掉，如 `temp\mainPage_Bug.jpg` 所示
    - How:
        1. 分析主頁 CSS 佈局結構
        2. 檢查 overflow 屬性設定
        3. 確認響應式設計斷點
        4. 修復寬度計算問題 (可能是 100vw vs 100% 問題)
        5. 測試各種螢幕尺寸
- **Resources Required**:
    - Materials: `temp\mainPage_Bug.jpg` 錯誤截圖
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/page.tsx` 或主頁元件
        - `src/app/layout.tsx` 全域佈局
        - 相關 CSS/Tailwind 樣式
- **Deliverables**:
    - [ ] 診斷 UI 跑版根本原因
    - [ ] 修復水平滾動問題
    - [ ] 跨瀏覽器測試 (Chrome, Firefox, Safari)
    - [ ] 不同螢幕尺寸測試
- **Dependencies**: 無
- **Constraints**: 不可影響其他頁面的佈局
- **Completion Status**: 未開始
- **Notes**: 常見原因包括 100vw 包含滾動條寬度、絕對定位元素超出容器等

---

## Phase 2: 成就與遊戲化系統

### [ ] **Task 2.1**: 虛擬居所功能實作
- **Task Name**: 實作虛擬居所、已解鎖內容、專屬獎勵的實際功能
- **Estimated completed time**: 8-12 小時
- **Work Description**:
    - Why: 目前這些功能只有前端 UI 雛形，沒有實際功能邏輯，包括：
        - 虛擬居所 → 榮府外院
        - 已解鎖內容 → 入門指南、基礎人物介紹
        - 專屬獎勵 → 訪客木框、新來者徽章
    - How:
        1. 設計虛擬居所的進度系統 (與等級/成就連動)
        2. 實作已解鎖內容的條件判斷邏輯
        3. 建立獎勵發放機制
        4. 連接 SQLite 資料庫儲存解鎖狀態
        5. 設計 UI 回饋效果
- **Resources Required**:
    - Materials: 遊戲化設計規格、等級系統文檔
    - Personnel: 前端開發者 1 名、可能需要設計師協助
    - Reference Codes/docs:
        - `src/app/(main)/achievements/page.tsx:78-92` - 現有假資料結構
        - `src/lib/user-level-service.ts` - 等級服務
        - `src/lib/config/levels-config.ts` - 等級配置
- **Deliverables**:
    - [ ] 虛擬居所進度系統設計文檔
    - [ ] 已解鎖內容判斷邏輯實作
    - [ ] 專屬獎勵發放功能
    - [ ] 資料庫結構調整 (如需要)
    - [ ] UI 整合測試
- **Dependencies**: Task 2.2 (學習進度)
- **Constraints**: 需與現有等級系統 (LevelDisplay) 整合
- **Completion Status**: 未開始
- **Notes**: 可分階段實作，優先完成基礎功能，後續再擴充

---

### [ ] **Task 2.2**: 學習進度總覽動態數據
- **Task Name**: 將學習進度總覽連接實際數據
- **Estimated completed time**: 6-8 小時
- **Work Description**:
    - Why: 目前 `learningStatsData` 使用硬編碼假資料 (`src/app/(main)/achievements/page.tsx:85-91`)，需要連接實際的使用者學習數據
    - How:
        1. 建立 API 端點取得使用者學習統計
        2. 從 SQLite 查詢實際數據：
           - 總閱讀時間
           - 已完成章回數
           - 筆記數量
           - 當前連續天數
        3. 替換前端假資料為 API 回傳值
        4. 添加資料載入狀態處理
- **Resources Required**:
    - Materials: SQLite 資料庫結構文檔
    - Personnel: 全端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/achievements/page.tsx:85-91` - 假資料位置
        - `src/lib/repositories/` - 資料庫查詢
        - `src/lib/user-level-service.ts` - 使用者等級服務
        - `data/local-db/redmansion.db` - SQLite 資料庫
- **Deliverables**:
    - [ ] 建立 `/api/user/learning-stats` API 端點
    - [ ] 實作資料庫查詢邏輯
    - [ ] 前端整合動態數據
    - [ ] 資料載入/錯誤狀態處理
    - [ ] 單元測試
- **Dependencies**: 無
- **Constraints**: 需要確認現有資料庫結構支援所需查詢
- **Completion Status**: 未開始
- **Notes**: 某些統計 (如總閱讀時間) 可能需要新增追蹤機制

---

## Phase 3: 每日修身系統修復

### [ ] **Task 3.1**: 任務顯示 Bug 修復
- **Task Name**: 修復完成任務後不顯示其他任務的問題
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 當使用者完成一項任務後，其他未完成的任務不再顯示，如 `temp\dailyTASK_Bug.jpg` 所示。重新進入頁面時會重新顯示「正在生成今日任務...」，但任務明明已經生成過了
    - How:
        1. 分析 `loadDailyTasks()` 函數邏輯 (`src/app/(main)/daily-tasks/page.tsx:263-386`)
        2. 檢查任務完成後的狀態更新邏輯
        3. 確認 `hasLoadedTasksRef` 和 `currentUserIdRef` 追蹤邏輯
        4. 修復任務清單渲染條件
        5. 測試多任務完成流程
- **Resources Required**:
    - Materials: `temp\dailyTASK_Bug.jpg` 錯誤截圖
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/daily-tasks/page.tsx:182-221` - useEffect 載入邏輯
        - `src/app/(main)/daily-tasks/page.tsx:450-458` - 任務提交後重載邏輯
        - `src/lib/daily-task-service.ts` - 任務服務
- **Deliverables**:
    - [ ] 診斷任務顯示 bug 根本原因
    - [ ] 修復任務清單渲染邏輯
    - [ ] 修復重複「生成任務」顯示問題
    - [ ] 完整流程測試 (生成 → 完成 → 顯示剩餘任務)
- **Dependencies**: 無
- **Constraints**: 需保留防止重複載入的機制
- **Completion Status**: 未開始
- **Notes**: 可能與 `hasLoadedTasksRef.current` 的重置時機有關

---

### [ ] **Task 3.2**: 預生成題目系統
- **Task Name**: 將每日任務改為預生成題目，由開發者匯入
- **Estimated completed time**: 8-10 小時
- **Work Description**:
    - Why: AI 即時生成題目速度太慢，需要改為預先生成好題庫，減少使用者等待時間
    - How:
        1. 設計題庫資料結構 (JSON/SQLite)
        2. 建立題目匯入機制
        3. 修改 task-generator 改為從題庫隨機選取
        4. 保留按難度/類型/章回篩選功能
        5. 建立題目管理介面 (選擇性)
- **Resources Required**:
    - Materials: 預生成的題目內容 (需要準備)
    - Personnel: 全端開發者 1 名、內容編輯 1 名
    - Reference Codes/docs:
        - `src/lib/task-generator.ts` - 現有生成器
        - `src/lib/config/daily-task-schema.ts` - 任務結構定義
        - `src/lib/daily-task-service.ts` - 任務服務
- **Deliverables**:
    - [ ] 題庫資料結構設計
    - [ ] 題目匯入腳本
    - [ ] 修改 task-generator 使用題庫
    - [ ] 至少 50-100 題的初始題庫
    - [ ] 測試題目選取邏輯
- **Dependencies**: Task 3.1
- **Constraints**: 需要人工準備題目內容
- **Completion Status**: 未開始
- **Notes**: 可先實作基礎功能，題目內容可持續擴充

---

### [ ] **Task 3.3**: 計畫介面設計
- **Task Name**: 將每日修身改為類似得到 App 的計畫介面
- **Estimated completed time**: 12-16 小時 (可分為設計與實作兩階段)
- **Work Description**:
    - Why: 提升使用者體驗，讓每日學習更有計畫性和目標感，參考得到 App 的設計風格
    - How:
        1. **階段一 - 設計 (4-6 小時)**
           - 參考得到 App 介面設計
           - 使用 PPT/Figma 設計介面原型
           - 確認日曆檢視功能需求
           - 設計學習挑戰賽功能流程
        2. **階段二 - 實作 (8-10 小時)**
           - 實作新的計畫介面 UI
           - 整合日曆元件 (TaskCalendar 已存在)
           - 實作學習挑戰賽實際功能
           - 連接後端 API
- **Resources Required**:
    - Materials: 得到 App 介面參考、設計工具 (PPT/Figma)
    - Personnel: UI/UX 設計師 1 名、前端開發者 1 名
    - Reference Codes/docs:
        - `src/components/daily-tasks/TaskCalendar.tsx` - 現有日曆元件
        - `src/app/(main)/daily-tasks/page.tsx:698-802` - 現有挑戰賽 UI (placeholder)
        - 得到 App 參考截圖
- **Deliverables**:
    - [ ] UI/UX 設計原型 (PPT/Figma)
    - [ ] 新的計畫介面頁面
    - [ ] 日曆功能整合
    - [ ] 學習挑戰賽功能實作
    - [ ] 使用者測試與回饋
- **Dependencies**: Task 3.1, Task 3.2
- **Constraints**: 設計需先完成才能開始實作
- **Completion Status**: 未開始
- **Notes**: 這是較大的功能重構，建議分階段進行，11/25 前完成基礎版本

---

## Phase 4: 閱讀頁面功能修復

### [ ] **Task 4.1**: AI 問答對話歷史保存
- **Task Name**: 修復重新打開 Toggle 視窗時對話內容消失的問題
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 重新打開 AI 問答 Toggle 視窗時，之前的對話內容會消失，需要再重新輸入送出 query 才會出現上次對話紀錄
    - How:
        1. 分析 `activeSessionMessages` 的狀態管理 (`src/app/(main)/read-book/page.tsx:2804`)
        2. 檢查 Sheet 開關時的狀態保持邏輯
        3. 實作對話歷史持久化 (localStorage 或 state 保持)
        4. 確保關閉再開啟時能正確載入歷史對話
- **Resources Required**:
    - Materials: 現有問答模組文檔
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:2804-2807` - activeSessionMessages
        - `src/components/ui/ConversationFlow.tsx` - 對話流程元件
        - `src/app/(main)/read-book/page.tsx:3504-3508` - ConversationFlow 使用
- **Deliverables**:
    - [ ] 對話歷史狀態保持機制
    - [ ] Toggle 開關時對話不消失
    - [ ] 可選：對話歷史持久化到 localStorage
    - [ ] 測試各種開關場景
- **Dependencies**: 無
- **Constraints**: 需考慮記憶體使用量
- **Completion Status**: 未開始
- **Notes**: 可能是 Sheet 元件的 unmount 行為導致

---

### [ ] **Task 4.2**: AI 問答回覆功能修復 
- **Task Name**: 修復送出 query 後 AI 未進行答覆的問題
- **Estimated completed time**: 6-8 小時
- **Work Description**:
    - Why: 目前送出 query 後，AI 並未如預期進行答覆
    - How:
        1. 檢查 `handleUserSubmitQuestion` 函數 (`src/app/(main)/read-book/page.tsx:1331-1349`)
        2. 確認 Perplexity API 呼叫流程
        3. 檢查錯誤處理與日誌輸出
        4. 驗證 API 金鑰與端點配置
        5. 測試 streaming 回應邏輯
- **Resources Required**:
    - Materials: Perplexity API 文檔、API 金鑰
    - Personnel: 全端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:1331-1349` - 提交問題邏輯
        - `src/ai/flows/perplexity-red-chamber-qa.ts` - Perplexity 整合
        - `src/lib/perplexity-error-handler.ts` - 錯誤處理
        - `logs/perplexity-debug-*.log` - 除錯日誌
- **Deliverables**:
    - [ ] 診斷 AI 回覆失敗原因
    - [ ] 修復 API 呼叫邏輯
    - [ ] 確認 streaming 回應正常
    - [ ] 錯誤處理與使用者回饋
    - [ ] 完整問答流程測試
- **Dependencies**: 無
- **Constraints**: 需要有效的 Perplexity API 金鑰
- **Completion Status**: 未開始
- **Notes**: 檢查 `.env.local` 中的 API 配置
- **AI問答顯示出以下訊息:**
  - Thought for 10 seconds
    我
    ⚠️ 系統僅收到 AI 的思考內容，以下為原始推理紀錄： 我

---

### [ ] **Task 4.3**: 成就通知顯示優化
- **Task Name**: 成就只在首次觸發時顯示通知
- **Estimated completed time**: 2-3 小時
- **Work Description**:
    - Why: 目前成就如「心有疑，隨札記」會時時通知，應該只在首次觸發時顯示
    - How:
        1. 追蹤成就顯示狀態 (已通知/未通知)
        2. 在 localStorage 或資料庫記錄已顯示的成就
        3. 修改成就通知邏輯，只在首次觸發時顯示
        4. 確保重新登入後仍能正確判斷
- **Resources Required**:
    - Materials: 成就系統文檔
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx` - 成就觸發邏輯
        - `src/components/gamification/` - 遊戲化元件
- **Deliverables**:
    - [ ] 成就通知狀態追蹤機制
    - [ ] 修改通知顯示條件
    - [ ] 測試各種成就首次觸發場景
- **Dependencies**: 無
- **Constraints**: 無
- **Completion Status**: 未開始
- **Notes**: 可用 localStorage 快速實作

---

### [ ] **Task 4.4**: 補充章回內容至 20 回
- **Task Name**: 補充紅樓夢內容至第 20 回
- **Estimated completed time**: 8-12 小時 (主要為內容準備時間)
- **Work Description**:
    - Why: 目前只有第 1 回有完整內容，第 2-25 回只有示例段落 (`src/app/(main)/read-book/page.tsx:190-199`)
    - How:
        1. 準備第 2-20 回的原文與白話文內容
        2. 按照現有格式 (`Paragraph[]` 結構) 整理資料
        3. 添加必要的註釋 (annotations)
        4. 匯入 chapters_base_data
        5. 測試各章回顯示
- **Resources Required**:
    - Materials: 紅樓夢原文及白話文譯本
    - Personnel: 內容編輯 1 名、開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:163-199` - 章回資料結構
        - 第 1 回完整範例 (`src/app/(main)/read-book/page.tsx:164-188`)
- **Deliverables**:
    - [ ] 第 2-20 回原文內容
    - [ ] 第 2-20 回白話文翻譯
    - [ ] 重要詞句註釋
    - [ ] 資料匯入與格式驗證
    - [ ] 各章回顯示測試
- **Dependencies**: 無
- **Constraints**: 需要人工準備與校對內容，時間較長
- **Completion Status**: 未開始
- **Notes**: 這是內容工作，可與其他技術任務並行進行

---

### [ ] **Task 4.5**: 雙欄閱讀功能修復
- **Task Name**: 修復雙欄模式只顯示一半的 Bug
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 雙欄功能未實現完成，只顯示一半內容，如 `temp\BiColumnReadArea._Bugjpg.jpg` 所示
    - How:
        1. 分析雙欄模式的 CSS 佈局與分頁邏輯
        2. 檢查 `computePagination()` 函數
        3. 確認 `isPaginationMode` 狀態判斷
        4. 修復內容分割與顯示邏輯
        5. 測試不同螢幕尺寸與字體大小
- **Resources Required**:
    - Materials: `temp\BiColumnReadArea._Bugjpg.jpg` 錯誤截圖
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:1050-1130` - 雙欄分頁邏輯
        - `src/app/(main)/read-book/page.tsx:222` - ColumnLayout 類型
        - `src/app/(main)/read-book/page.tsx:493` - columnLayout 狀態
- **Deliverables**:
    - [ ] 診斷雙欄顯示 bug 根本原因
    - [ ] 修復分頁計算邏輯
    - [ ] 完整雙欄顯示功能
    - [ ] 不同螢幕尺寸測試
    - [ ] 字體大小變化測試
- **Dependencies**: 無
- **Constraints**: 需要處理多種裝置與螢幕尺寸
- **Completion Status**: 未開始
- **Notes**: 可能與 ResizeObserver 或分頁計算有關

---

## 工作優先順序建議
**初始修復先給claude，再不行再給codex

### 高優先 (必須在 11/25 前完成)
1. **Task 4.2** - AI 問答回覆功能修復 (核心功能) - 未修復完成
2. **Task 3.1** - 任務顯示 Bug 修復 (影響使用體驗) - 修復完成
3. **Task 1.3** - 主頁 UI 佈局修復 (影響第一印象) - 未修復完成
   `To continue this session, run codex resume 019a9bec-89e0-7b50-85d8-fae1886f4e78`
4. **Task 4.1** - AI 問答對話歷史保存 (使用體驗) - 修復完成
(需要進行修復npm run typecheck與lint)

### 中優先 (盡量完成)
5. **Task 4.5** - 雙欄閱讀功能修復 - 修復完成，待驗證
6. **Task 1.1** - 頁面編譯效能優化 - 未修復成功
7. **Task 1.2** - Loading 動畫效果修復 - 修復完成，待驗證
8. **Task 4.3** - 成就通知顯示優化 - 修復完成

### 可延後 (時間允許再處理)
9. **Task 2.2** - 學習進度總覽動態數據
10. **Task 2.1** - 虛擬居所功能實作
11. **Task 3.2** - 預生成題目系統
12. **Task 4.4** - 補充章回內容至 20 回
13. **Task 3.3** - 計畫介面設計 (建議分階段，11/25 前完成設計原型)

---

## 時間估算總覽

| Phase | 預估時間 | 說明 |
|-------|----------|------|
| Phase 1 | 9-13 小時 | 系統基礎與效能 |
| Phase 2 | 14-20 小時 | 成就與遊戲化 |
| Phase 3 | 24-32 小時 | 每日修身系統 |
| Phase 4 | 24-35 小時 | 閱讀頁面功能 |
| **總計** | **71-100 小時** | |

**建議**：
- 每日工作 8 小時，5 天共 40 小時
- 優先完成高優先任務 (約 18-26 小時)
- 中優先任務 (約 15-22 小時)
- 剩餘時間處理低優先任務

---

## 風險與備註

1. **內容準備風險**：Task 4.4 (補充章回) 和 Task 3.2 (預生成題目) 需要大量人工內容準備，可能超出預估時間
2. **API 配置風險**：Task 4.2 需要確認 Perplexity API 配置正確
3. **設計依賴**：Task 3.3 需要先完成設計原型才能開始實作
4. **測試時間**：每個任務完成後需要預留測試時間

**建議進行每日 Stand-up**：追蹤進度並及時調整優先順序

---

## Phase 5: Azure 雲端部署上線

### [ ] **Task 5.1**: 環境變數與配置準備
- **Task Name**: 整理並配置所有 Azure 部署所需的環境變數
- **Estimated completed time**: 3-4 小時
- **Work Description**:
    - Why: Azure 部署需要完整的環境變數配置，包括 API 金鑰、資料庫連接、NextAuth 設定等，必須確保所有敏感資訊正確設定
    - How:
        1. 檢查 `.env.local` 並列出所有環境變數
        2. 確認以下關鍵配置項目：
           - `OPENAI_API_KEY` - OpenAI GPT-4-mini API 金鑰
           - `PERPLEXITY_API_KEY` - Perplexity Sonar API 金鑰
           - `NEXTAUTH_SECRET` - NextAuth.js 加密金鑰
           - `NEXTAUTH_URL` - 生產環境 URL
           - `DATABASE_URL` - 資料庫連接字串 (依據 Task 5.2 決策)
        3. 使用 Azure Key Vault 儲存敏感資訊 (推薦)
        4. 準備環境變數文檔供部署使用
        5. 驗證 `src/lib/env.ts` 的 Zod schema 涵蓋所有必要變數
- **Resources Required**:
    - Materials: `.env.local` 檔案、Azure Key Vault 文檔
    - Personnel: DevOps 工程師 1 名
    - Reference Codes/docs:
        - `src/lib/env.ts` - 環境變數驗證 schema
        - `.env.example` (如存在)
        - Azure Key Vault 設定指南
- **Deliverables**:
    - [ ] 完整環境變數清單文檔
    - [ ] Azure Key Vault 配置 (或 App Service 環境變數設定)
    - [ ] `NEXTAUTH_SECRET` 生成 (使用 `openssl rand -base64 32`)
    - [ ] 生產環境 URL 確認與設定
    - [ ] 環境變數驗證測試
- **Dependencies**: 無
- **Constraints**: API 金鑰需要有足夠的配額與權限
- **Completion Status**: 未開始
- **Notes**: 生產環境務必使用 Azure Key Vault 管理敏感資訊

---

### [ ] **Task 5.2**: 資料庫遷移規劃與決策
- **Task Name**: 決定 SQLite 雲端化方案或遷移至 Azure SQL Database
- **Estimated completed time**: 6-10 小時 (依選擇方案而定)
- **Work Description**:
    - Why: 目前使用 SQLite 本地檔案資料庫，雲端部署會面臨檔案系統臨時性、無法水平擴展等問題，需要評估最佳解決方案
    - How:
        1. **方案評估 (2 小時)**:
           - **方案 A**: Azure Blob Storage 持久化 SQLite (低成本，快速實作)
           - **方案 B**: 遷移至 Azure SQL Database (生產級別，長期穩定)
           - **方案 C**: 使用 Turso (LibSQL 雲端服務，保持 SQLite 相容性)
        2. **選擇方案 A (Azure Blob Storage + SQLite) - 4-6 小時**:
           - 安裝 `@azure/storage-blob` 套件
           - 實作 SQLite 檔案同步機制 (啟動時下載，定期上傳)
           - 修改 `src/lib/sqlite-db.ts` 整合 Blob Storage
           - 測試資料持久化
        3. **選擇方案 B (Azure SQL Database) - 8-12 小時**:
           - 建立 Azure SQL Database 實例
           - 安裝 `mssql` 或 `pg` (PostgreSQL) 套件
           - 重構 `src/lib/repositories/` 改用 SQL 查詢
           - 執行資料遷移腳本
           - 修改所有資料存取層
        4. **選擇方案 C (Turso) - 4-6 小時**:
           - 註冊 Turso 帳號並建立資料庫
           - 安裝 `@libsql/client` 套件
           - 修改 `src/lib/sqlite-db.ts` 使用 Turso client
           - 執行 schema 初始化
- **Resources Required**:
    - Materials: Azure SQL/Blob Storage 文檔、Turso 文檔
    - Personnel: 後端開發者 1 名、DBA (如選擇方案 B)
    - Reference Codes/docs:
        - `src/lib/sqlite-db.ts` - 資料庫初始化
        - `src/lib/repositories/` - 所有資料存取邏輯
        - `scripts/migrations/` - 歷史遷移腳本參考
- **Deliverables**:
    - [ ] 資料庫方案評估報告
    - [ ] 選定方案實作完成
    - [ ] 資料遷移測試 (如需要)
    - [ ] 備份與還原機制
    - [ ] 連線測試與效能驗證
- **Dependencies**: 無
- **Constraints**: 需考慮成本、效能、維護複雜度
- **Completion Status**: 未開始
- **Notes**: **推薦快速上線選 A，長期穩定選 B，保持相容性選 C**

---

### [ ] **Task 5.3**: Azure 資源建立與配置
- **Task Name**: 建立 Azure App Service 或 Container Apps 並完成部署配置
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 需要在 Azure 建立實際運行應用程式的計算資源，選擇適合的服務方案並完成基礎配置
    - How:
        1. **選擇部署方案**:
           - **方案 A**: Azure App Service (Web App for Linux) - 推薦初次部署
           - **方案 B**: Azure Container Apps - 推薦生產環境
        2. **App Service 部署流程** (方案 A):
           - 登入 Azure Portal
           - 建立 Resource Group (`rg-redmansion-prod`)
           - 建立 App Service Plan (B1 或 P1v2 等級)
           - 建立 Web App (Runtime: Node.js 20 LTS, OS: Linux)
           - 設定 Deployment Center 連接 GitHub repository
           - 配置環境變數 (從 Task 5.1)
           - 啟用 Application Insights (可選)
        3. **Container Apps 部署流程** (方案 B):
           - 建立 Container Registry (ACR)
           - 編寫 `Dockerfile` (參考下方)
           - 建立 Container App Environment
           - 配置 Container App (min/max replicas, CPU/Memory)
           - 設定環境變數與 secrets
        4. **共同配置**:
           - 設定自訂網域名稱 (如有)
           - 啟用 HTTPS (Let's Encrypt 或 Azure 憑證)
           - 配置 CORS 設定
- **Resources Required**:
    - Materials: Azure 訂閱帳號、GitHub repository
    - Personnel: DevOps 工程師 1 名
    - Reference Codes/docs:
        - `package.json:6-8` - build scripts
        - `next.config.ts` - Next.js 配置
        - Azure App Service 文檔
        - Azure Container Apps 文檔
- **Deliverables**:
    - [ ] Azure Resource Group 建立
    - [ ] App Service 或 Container App 建立
    - [ ] 環境變數配置完成
    - [ ] HTTPS 啟用
    - [ ] 自訂網域設定 (如需要)
    - [ ] 健康檢查端點配置
- **Dependencies**: Task 5.1 (環境變數), Task 5.2 (資料庫)
- **Constraints**: 需要 Azure 訂閱與足夠的配額
- **Completion Status**: 未開始
- **Notes**: **推薦初次使用 App Service，熟悉後再考慮 Container Apps**

**Dockerfile 參考** (如選擇 Container Apps):
```dockerfile
FROM node:20-alpine AS base

# Dependencies
FROM base AS deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

# Builder
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# Runner
FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT=3000
CMD ["node", "server.js"]
```

---

### [ ] **Task 5.4**: CI/CD 管道設定
- **Task Name**: 建立 GitHub Actions 自動化部署管道
- **Estimated completed time**: 3-5 小時
- **Work Description**:
    - Why: 自動化部署流程可確保每次程式碼更新都能快速、一致地部署到 Azure，減少人為錯誤
    - How:
        1. 在專案根目錄建立 `.github/workflows/azure-deploy.yml`
        2. 配置 workflow 包含以下步驟：
           - Checkout 程式碼
           - 設定 Node.js 20 環境
           - 安裝相依套件 (`npm ci`)
           - 執行 TypeScript 類型檢查 (`npm run typecheck`)
           - 執行 Linting (`npm run lint`)
           - 執行測試套件 (`npm test`)
           - 建置生產版本 (`npm run build`)
           - 部署至 Azure (使用 Azure/webapps-deploy action)
        3. 設定 GitHub Secrets:
           - `AZURE_WEBAPP_PUBLISH_PROFILE` (App Service)
           - 或 `AZURE_CREDENTIALS` (Container Apps)
        4. 設定觸發條件 (push to main branch)
        5. 測試部署流程
- **Resources Required**:
    - Materials: GitHub repository、Azure 部署憑證
    - Personnel: DevOps 工程師 1 名
    - Reference Codes/docs:
        - `package.json:9-11` - lint, typecheck, test scripts
        - GitHub Actions 文檔
        - Azure deployment actions 文檔
- **Deliverables**:
    - [ ] `.github/workflows/azure-deploy.yml` 檔案
    - [ ] GitHub Secrets 配置
    - [ ] 首次自動部署測試成功
    - [ ] 部署失敗通知設定 (email/Slack)
    - [ ] Deployment 狀態 badge (可選)
- **Dependencies**: Task 5.3 (Azure 資源)
- **Constraints**: 需要 GitHub Actions 分鐘數配額
- **Completion Status**: 未開始
- **Notes**: 建議先設定手動觸發 (workflow_dispatch) 測試完成後再啟用自動觸發

**GitHub Actions Workflow 參考**:
```yaml
name: Deploy to Azure

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'your-app-name'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .
```

---

### [ ] **Task 5.5**: 部署測試與驗證
- **Task Name**: 生產環境完整功能測試與效能驗證
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 確保生產環境所有功能正常運作，效能符合預期，並建立監控機制以便及時發現問題
    - How:
        1. **功能測試 (2-3 小時)**:
           - [ ] 使用者註冊/登入流程測試
           - [ ] 閱讀頁面功能測試 (AI 問答、筆記、劃線)
           - [ ] 每日修身任務生成與提交
           - [ ] 社群功能測試 (發文、留言、按讚)
           - [ ] 成就系統測試
           - [ ] 多語言切換測試
        2. **效能測試 (1-2 小時)**:
           - 使用 Lighthouse 進行效能評估
           - 測試頁面載入時間 (目標 < 3 秒)
           - 測試 API 回應時間
           - 測試資料庫查詢效能
           - 檢查 Core Web Vitals 指標
        3. **監控設定 (1 小時)**:
           - 啟用 Azure Application Insights
           - 設定錯誤追蹤與告警
           - 設定效能監控儀表板
           - 配置 Uptime monitoring
        4. **安全性檢查**:
           - HTTPS 正確配置
           - 環境變數無洩漏
           - CORS 設定正確
           - SQL Injection 防護驗證
- **Resources Required**:
    - Materials: 測試腳本、監控工具
    - Personnel: QA 測試人員 1 名、開發者 1 名
    - Reference Codes/docs:
        - 生產環境 URL
        - `tests/` 目錄下的測試案例參考
        - Azure Application Insights 文檔
- **Deliverables**:
    - [ ] 功能測試報告 (所有核心功能通過)
    - [ ] 效能測試報告 (Lighthouse 分數 > 80)
    - [ ] Azure Application Insights 配置完成
    - [ ] 錯誤告警規則設定
    - [ ] 部署檢查清單文檔
    - [ ] 已知問題清單 (如有)
- **Dependencies**: Task 5.4 (成功部署)
- **Constraints**: 需要真實使用者場景測試
- **Completion Status**: 未開始
- **Notes**: 建議建立 staging 環境先行測試，確認無誤後再部署至 production

**生產環境檢查清單**:
```markdown
## 部署前檢查
- [ ] 所有環境變數已正確設定
- [ ] 資料庫連線測試通過
- [ ] HTTPS 憑證有效
- [ ] API 金鑰有足夠配額

## 部署後驗證
- [ ] 首頁正常載入
- [ ] 登入/註冊功能正常
- [ ] AI 功能正常 (OpenAI + Perplexity)
- [ ] 資料庫讀寫正常
- [ ] 監控系統運作中
- [ ] 錯誤追蹤正常接收日誌
```

---

## Phase 5 優先順序與時間規劃

### 部署任務順序
1. **Task 5.1** - 環境變數準備 (必須最先完成)
2. **Task 5.2** - 資料庫遷移決策 (影響後續架構)
3. **Task 5.3** - Azure 資源建立 (核心基礎設施)
4. **Task 5.4** - CI/CD 設定 (自動化部署)
5. **Task 5.5** - 測試驗證 (上線前最終確認)

### 時間估算
| Task | 預估時間 | 關鍵程度 |
|------|----------|----------|
| Task 5.1 | 3-4 小時 | 🔴 必須 |
| Task 5.2 | 6-10 小時 | 🔴 必須 |
| Task 5.3 | 4-6 小時 | 🔴 必須 |
| Task 5.4 | 3-5 小時 | 🟡 推薦 |
| Task 5.5 | 4-6 小時 | 🔴 必須 |
| **總計** | **20-31 小時** | 約 3-4 工作天 |

### 部署風險評估
1. **資料庫遷移風險** (高):
   - SQLite → Azure SQL 遷移可能需要大量程式碼修改
   - 建議：優先選擇 Azure Blob Storage 方案 (Task 5.2 方案 A)

2. **API 配額風險** (中):
   - OpenAI 與 Perplexity API 可能有使用量限制
   - 建議：設定用量監控與告警

3. **效能風險** (中):
   - Next.js 15 SSR 在雲端可能有冷啟動延遲
   - 建議：使用 Always On 功能或升級至 Premium plan

4. **成本風險** (中):
   - Azure 資源使用可能產生預期外費用
   - 建議：設定 Cost Management 預算告警

### 建議部署策略
**快速上線方案** (適合 11/25 前上線):
- 資料庫: Azure Blob Storage + SQLite (Task 5.2 方案 A)
- 計算: Azure App Service B1 plan (Task 5.3 方案 A)
- 部署: 手動部署或簡易 GitHub Actions

**生產級方案** (適合長期穩定營運):
- 資料庫: Azure SQL Database 或 Turso
- 計算: Azure Container Apps (自動擴展)
- 部署: 完整 CI/CD 管道 + Staging 環境
