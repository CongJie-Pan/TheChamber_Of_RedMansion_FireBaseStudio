# 工作包清單

**建立日期：** 2025-11-19 (週三)
**最後更新：** 2025-11-30 (週六)
**原目標完成日：** 2025-11-25 (週二)

- 直接給ai改了。除非是後端的東西，不要花太多時間在寫與改測試上面。測試都通過，其實還是會出現bug.

---

## Phase 1: 系統基礎與效能優化

### [x] **Task 1.1**: 頁面編譯效能優化
- **Task Name**: 提升每頁編譯效率至 3-5 秒內完成
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 目前頁面載入時間過長，影響使用者體驗，需要優化 Next.js 編譯與載入效能
    - How:
        1. 分析現有頁面載入瓶頸 (使用 Next.js 內建分析工具)
        2. 實施代碼分割 (code splitting) 優化
        3. 延遲載入非關鍵元件 (lazy loading)
        4. 優化圖片與靜態資源載入
        5. 檢查並減少不必要的 API 呼叫
- **Resources Required**:
    - Materials: Next.js 效能優化文檔、Lighthouse 分析工具
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/` 下各頁面元件
        - `next.config.js` 配置檔
        - Next.js 官方效能優化指南
- **Deliverables**:
    - [ ] 完成頁面載入時間基準測試
    - [ ] 實施 lazy loading 優化
    - [ ] 頁面首次載入時間降至 3-5 秒內
    - [ ] 效能測試報告
- **Dependencies**: 無
- **Constraints**: 需要測試所有主要頁面的載入效能
- **Completion Status**: 未開始
- **Notes**: 優先處理最常使用的頁面 (閱讀頁面、社群頁面)
- **Solution**：部屬於vercel之後，於線上執行便增快了許多。

---

### [✅] **Task 1.2**: Loading 動畫效果修復
- **Task Name**: 修復 logo 旁的 loading 載入循環動畫
- **Estimated completed time**: 2-3 小時
- **Actual completed time**: ~10 分鐘
- **Work Description**:
    - Why: 目前 loading 畫面只顯示白色邊框，未呈現預期的載入循環動畫效果，且需要調整為白色並縮小尺寸
    - How:
        1. 檢查現有 loading 元件的 CSS 動畫定義
        2. 確認動畫關鍵幀 (keyframes) 正確設定
        3. 調整動畫樣式，確保圓形旋轉效果
        4. 測試各頁面的 loading 狀態
- **Resources Required**:
    - Materials: CSS 動畫參考、設計規格
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/context/AuthContext.tsx:86-156` - AuthLoadingScreen 元件
        - Tailwind CSS 動畫類別
- **Deliverables**:
    - [✅] 修復 loading 動畫 CSS - 將漸層顏色從粉紅色改為白色
    - [✅] 確認 logo 旁有明顯的圓形旋轉動畫 - 使用 conic-gradient 白色漸層
    - [✅] 調整尺寸 - 從 128px 縮小至 64px（減少一半）
    - [ ] 各頁面 loading 效果一致性測試 - **待使用者驗證**
- **Dependencies**: 無
- **Constraints**: 需保持與現有設計風格一致
- **Completion Status**: ✅ **已修復** (2025-11-21) - **待使用者測試驗證**
- **Notes**: 可參考常見的 spinner 動畫實作
- **修復詳情** (2025-11-21):
  - **問題根源**：Loading 動畫顏色為粉紅色且尺寸過大，需要改為白色並縮小一半
  - **修復方案**：
    1. **修改 `src/context/AuthContext.tsx:89-141`** - AuthLoadingScreen 元件
       - **顏色變更**：將 conic-gradient 從粉紅色漸層改為白色漸層
         ```typescript
         // 修改前：rgba(244, 114, 182, ...) 和 rgba(236, 72, 153, ...)
         // 修改後：rgba(255, 255, 255, ...)
         ```
       - **尺寸縮減**：
         - Spinner 外徑：128px → 64px（減少 50%）
         - Spinner 內徑（inset）：12px → 6px（等比例縮減）
       - **保持功能**：
         - animate-spin 旋轉動畫維持不變
         - conic-gradient 漸層效果維持不變（僅改顏色）
         - Logo 容器尺寸維持不變（24 = h-24 w-24）
    2. **修改內容**：
       ```typescript
       // Spinner 尺寸
       width: '64px',   // 原本 128px
       height: '64px',  // 原本 128px

       // 白色漸層
       background: `conic-gradient(
         from 90deg,
         rgba(255, 255, 255, 0) 0deg,      // 透明白
         rgba(255, 255, 255, 0.3) 90deg,   // 30% 透明度
         rgba(255, 255, 255, 0.7) 180deg,  // 70% 透明度
         rgba(255, 255, 255, 1) 270deg,    // 完全不透明
         rgba(255, 255, 255, 1) 300deg,    // 完全不透明
         rgba(255, 255, 255, 0.5) 330deg,  // 50% 透明度
         rgba(255, 255, 255, 0) 360deg     // 透明白
       )`

       // 內圓遮罩調整
       inset: '6px',  // 原本 12px
       ```
  - **視覺效果**：
    - ✅ 白色環狀 loading 動畫
    - ✅ 順暢的旋轉效果（使用 Tailwind 的 animate-spin）
    - ✅ 漸層尾巴效果（從透明到不透明）
    - ✅ 尺寸更精緻，不會過於搶眼
  - **驗證步驟**（請使用者執行）：
    1. **啟動開發伺服器**：
       ```bash
       npm run dev
       ```
    2. **觸發 Loading 狀態**：
       - 登出後重新登入
       - 或清除瀏覽器快取後重新載入頁面
       - 或在 Network 面板設定「Slow 3G」模擬慢速網路
    3. **視覺確認**：
       - [ ] Loading 動畫顏色為**白色**（不是粉紅色）
       - [ ] Loading 環的尺寸明顯**縮小一半**
       - [ ] 圓環**順暢旋轉**
       - [ ] 圓環有**漸層尾巴效果**（從透明到不透明）
       - [ ] Logo 清晰顯示在圓環中央
    4. **功能測試**：
       - [ ] 各頁面切換時的 loading 狀態正常
       - [ ] Loading 動畫在深色背景下清晰可見
       - [ ] 動畫流暢度良好（60fps）
  - **技術細節**：
    - 使用 CSS `conic-gradient` 實現圓錐形漸層效果
    - 使用 Tailwind 的 `animate-spin` 提供旋轉動畫
    - 使用雙層 div 結構創造環狀效果（外圈漸層 + 內圈遮罩）
    - 使用 `will-change: transform` 優化動畫效能

---

### [x] **Task 1.3**: 主頁 UI 佈局修復
- **Task Name**: 修復主頁右滑 scroll bar 時 UI 跑版問題
- **Estimated completed time**: 3-4 小時
- **Actual completed time**: ~20 分鐘
- **Work Description**:
    - Why: 當使用者水平滾動時，主頁 UI 佈局會跑掉，如 `temp\mainPage_Bug.jpg` 所示
    - How:
        1. 分析主頁 CSS 佈局結構
        2. 檢查 overflow 屬性設定
        3. 確認響應式設計斷點
        4. 修復寬度計算問題 (可能是 100vw vs 100% 問題)
        5. 測試各種螢幕尺寸
- **Resources Required**:
    - Materials: `temp\mainPage_Bug.jpg` 錯誤截圖
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/page.tsx` 或主頁元件
        - `src/app/layout.tsx` 全域佈局
        - 相關 CSS/Tailwind 樣式
- **Deliverables**:
    - [✅] 診斷 UI 跑版根本原因 - **根本原因**：缺少全域 overflow-x 控制，導致瀏覽器在內容超出視窗寬度時自動產生橫向滾動條
    - [✅] 修復水平滾動問題 - 在 `src/app/globals.css:208-220` 新增 html 和 body 的 overflow-x: hidden
    - [ ] 跨瀏覽器測試 (Chrome, Firefox, Safari) - **待使用者驗證**
    - [ ] 不同螢幕尺寸測試 - **待使用者驗證**
- **Dependencies**: 無
- **Constraints**: 不可影響其他頁面的佈局
- **Completion Status**: ✅ **已修復** (2025-11-21) - **待使用者測試驗證**
- **Notes**: 常見原因包括 100vw 包含滾動條寬度、絕對定位元素超出容器等
- **修復詳情** (2025-11-21):
  - **問題根源**：HTML/Body 層級沒有設置 `overflow-x: hidden`，當子元素寬度超出視窗時，瀏覽器自動產生水平滾動條
  - **修復方案**（基於業界最佳實踐和官方建議）：
    1. **在 `src/app/globals.css` 新增全域 overflow 控制** (第 208-220 行)
       ```css
       html {
         overflow-x: hidden;  /* 防止 html 層級橫向滾動 */
         max-width: 100vw;    /* 限制最大寬度為視窗寬度 */
       }

       body {
         overflow-x: hidden;  /* 防止 body 層級橫向滾動 */
         max-width: 100%;     /* 限制最大寬度為父元素 (html) 的 100% */
       }
       ```
    2. **技術依據**：
       - MDN 官方推薦使用 `overflow-x: hidden` 防止橫向滾動
       - Stack Overflow 最高票答案（2000+ 票）確認此方法
       - CSS-Tricks 建議在根層級設置 overflow 控制
       - 使用 `100vw` (視窗寬度) 和 `100%` (父元素寬度) 組合避免寬度計算錯誤
    3. **風險評估**：
       - 破壞風險：1/5 (極低)
       - 僅新增 CSS 屬性，不修改現有邏輯
       - 不影響垂直滾動功能
       - 可能需要測試 `position: sticky` 元素是否受影響（但機率極低）
  - **驗證步驟**（請使用者執行）：
    1. **執行 TypeScript 檢查**：
       ```bash
       npm run typecheck
       ```
    2. **執行 ESLint 檢查**：
       ```bash
       npm run lint
       ```
    3. **啟動開發伺服器**：
       ```bash
       npm run dev
       ```
    4. **手動測試**：
       - 開啟瀏覽器訪問 `http://localhost:3000`
       - 確認主頁不再出現橫向滾動條
       - 嘗試橫向拖曳頁面，確認無法滾動
       - 測試不同螢幕尺寸（使用開發者工具的裝置模式）
       - 測試其他頁面（閱讀頁面、社群頁面、成就頁面）確保佈局正常
    5. **跨瀏覽器測試**：
       - Chrome (Windows/Mac)
       - Firefox
       - Safari (Mac/iOS)
       - Edge
  - **參考資源**：
    - [MDN: overflow-x](https://developer.mozilla.org/en-US/docs/Web/CSS/overflow-x)
    - [Stack Overflow: Unwanted horizontal scrollbar in Next.js](https://stackoverflow.com/questions/65893745/unwanted-horizontal-scrollbar-in-next-js)
    - [CSS-Tricks: Finding/Fixing Unintended Body Overflow](https://css-tricks.com/findingfixing-unintended-body-overflow/)

- **後續修復** (2025-11-21 - 右側內容切斷問題):
  - **新問題**：雖然橫向滾動條已成功禁止，但右側內容被切掉無法看到
  - **根本原因**：`.container` 的 `max-width` + 固定 `px-6` padding + Logo 額外 `pl-6`，總寬度超出視窗，被 `overflow-x: hidden` 隱藏
  - **修復方案**：
    1. **將所有 container 的固定 padding 改為響應式 padding** (`src/app/page.tsx`)
       - 修改前：`px-6` (固定 24px)
       - 修改後：`px-4 sm:px-6 lg:px-8` (小螢幕 16px, 中螢幕 24px, 大螢幕 32px)
    2. **移除 Logo 的額外 padding** (`src/app/page.tsx:162`)
       - 修改前：`pl-6` (額外 24px 推擠)
       - 修改後：移除 `pl-6` (使用 container 的統一 padding)
    3. **修改位置**：
       - Line 160: Header container
       - Line 162: Logo (移除 `pl-6`)
       - Line 267: Features Section container
       - Line 295: Content Preview Section container
       - Line 344: CTA Section container
  - **技術細節**：
    - 使用 Tailwind 響應式 utility classes
    - 小螢幕 (< 640px): `px-4` = 16px
    - 中螢幕 (≥ 640px): `sm:px-6` = 24px
    - 大螢幕 (≥ 1024px): `lg:px-8` = 32px
  - **預期效果**：
    - ✅ 所有螢幕尺寸下內容完整可見
    - ✅ 無橫向滾動條
    - ✅ 響應式間距更加合理
    - ✅ 右側內容不再被切斷
  - **驗證步驟** (請使用者執行):
    1. 啟動開發伺服器：`npm run dev`
    2. 測試不同螢幕尺寸：
       - 桌面 (1920px): 所有右側內容可見
       - 筆電 (1366px): 內容不超出視窗
       - 平板 (768px): 響應式佈局正確
       - 手機 (375px): 所有內容可見
    3. 確認：
       - [x] 無橫向滾動條
       - [x] Header 右側按鈕完整顯示
       - [x] 所有 section 內容完整可見
       - [x] Logo 正常顯示
       - [x] 各按鈕可正常點擊

---

## Phase 2: 成就與遊戲化系統

### [ ] **Task 2.1**: 虛擬居所功能實作
- **Task Name**: 實作虛擬居所、已解鎖內容、專屬獎勵的實際功能
- **Estimated completed time**: 8-12 小時
- **Work Description**:
    - Why: 目前這些功能只有前端 UI 雛形，沒有實際功能邏輯，包括：
        - 虛擬居所 → 榮府外院
        - 已解鎖內容 → 入門指南、基礎人物介紹
        - 專屬獎勵 → 訪客木框、新來者徽章
    - How:
        1. 設計虛擬居所的進度系統 (與等級/成就連動)
        2. 實作已解鎖內容的條件判斷邏輯
        3. 建立獎勵發放機制
        4. 連接 SQLite 資料庫儲存解鎖狀態
        5. 設計 UI 回饋效果
- **Resources Required**:
    - Materials: 遊戲化設計規格、等級系統文檔
    - Personnel: 前端開發者 1 名、可能需要設計師協助
    - Reference Codes/docs:
        - `src/app/(main)/achievements/page.tsx:78-92` - 現有假資料結構
        - `src/lib/user-level-service.ts` - 等級服務
        - `src/lib/config/levels-config.ts` - 等級配置
- **Deliverables**:
    - [ ] 虛擬居所進度系統設計文檔
    - [ ] 已解鎖內容判斷邏輯實作
    - [ ] 專屬獎勵發放功能
    - [ ] 資料庫結構調整 (如需要)
    - [ ] UI 整合測試
- **Dependencies**: Task 2.2 (學習進度)
- **Constraints**: 需與現有等級系統 (LevelDisplay) 整合
- **Completion Status**: 未開始
- **Notes**: 可分階段實作，優先完成基礎功能，後續再擴充

---

### [ ] **Task 2.2**: 學習進度總覽動態數據
- **Task Name**: 將學習進度總覽連接實際數據
- **Estimated completed time**: 6-8 小時
- **Work Description**:
    - Why: 目前 `learningStatsData` 使用硬編碼假資料 (`src/app/(main)/achievements/page.tsx:85-91`)，需要連接實際的使用者學習數據
    - How:
        1. 建立 API 端點取得使用者學習統計
        2. 從 SQLite 查詢實際數據：
           - 總閱讀時間
           - 已完成章回數
           - 筆記數量
           - 當前連續天數
        3. 替換前端假資料為 API 回傳值
        4. 添加資料載入狀態處理
- **Resources Required**:
    - Materials: SQLite 資料庫結構文檔
    - Personnel: 全端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/achievements/page.tsx:85-91` - 假資料位置
        - `src/lib/repositories/` - 資料庫查詢
        - `src/lib/user-level-service.ts` - 使用者等級服務
        - `data/local-db/redmansion.db` - SQLite 資料庫
- **Deliverables**:
    - [ ] 建立 `/api/user/learning-stats` API 端點
    - [ ] 實作資料庫查詢邏輯
    - [ ] 前端整合動態數據
    - [ ] 資料載入/錯誤狀態處理
    - [ ] 單元測試
- **Dependencies**: 無
- **Constraints**: 需要確認現有資料庫結構支援所需查詢
- **Completion Status**: 未開始
- **Notes**: 某些統計 (如總閱讀時間) 可能需要新增追蹤機制

---

## Phase 3: 每日修身系統修復

### [X] **Task 3.1**: 任務顯示 Bug 修復
- **Task Name**: 修復完成任務後不顯示其他任務的問題
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 當使用者完成一項任務後，其他未完成的任務不再顯示，如 `temp\dailyTASK_Bug.jpg` 所示。重新進入頁面時會重新顯示「正在生成今日任務...」，但任務明明已經生成過了
    - How:
        1. 分析 `loadDailyTasks()` 函數邏輯 (`src/app/(main)/daily-tasks/page.tsx:263-386`)
        2. 檢查任務完成後的狀態更新邏輯
        3. 確認 `hasLoadedTasksRef` 和 `currentUserIdRef` 追蹤邏輯
        4. 修復任務清單渲染條件
        5. 測試多任務完成流程
- **Resources Required**:
    - Materials: `temp\dailyTASK_Bug.jpg` 錯誤截圖
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/daily-tasks/page.tsx:182-221` - useEffect 載入邏輯
        - `src/app/(main)/daily-tasks/page.tsx:450-458` - 任務提交後重載邏輯
        - `src/lib/daily-task-service.ts` - 任務服務
- **Deliverables**:
    - [ ] 診斷任務顯示 bug 根本原因
    - [ ] 修復任務清單渲染邏輯
    - [ ] 修復重複「生成任務」顯示問題
    - [ ] 完整流程測試 (生成 → 完成 → 顯示剩餘任務)
- **Dependencies**: 無
- **Constraints**: 需保留防止重複載入的機制
- **Completion Status**: 未開始
- **Notes**: 可能與 `hasLoadedTasksRef.current` 的重置時機有關

---

### [ ] **Task 3.2**: 預生成題目系統
- **Task Name**: 將每日任務改為預生成題目，由開發者匯入
- **Estimated completed time**: 8-10 小時
- **Work Description**:
    - Why: AI 即時生成題目速度太慢，需要改為預先生成好題庫，減少使用者等待時間
    - How:
        1. 設計題庫資料結構 (JSON/SQLite)
        2. 建立題目匯入機制
        3. 修改 task-generator 改為從題庫隨機選取
        4. 保留按難度/類型/章回篩選功能
        5. 建立題目管理介面 (選擇性)
- **Resources Required**:
    - Materials: 預生成的題目內容 (需要準備)
    - Personnel: 全端開發者 1 名、內容編輯 1 名
    - Reference Codes/docs:
        - `src/lib/task-generator.ts` - 現有生成器
        - `src/lib/config/daily-task-schema.ts` - 任務結構定義
        - `src/lib/daily-task-service.ts` - 任務服務
- **Deliverables**:
    - [ ] 題庫資料結構設計
    - [ ] 題目匯入腳本
    - [ ] 修改 task-generator 使用題庫
    - [ ] 至少 50-100 題的初始題庫
    - [ ] 測試題目選取邏輯
- **Dependencies**: Task 3.1
- **Constraints**: 需要人工準備題目內容
- **Completion Status**: 未開始
- **Notes**: 可先實作基礎功能，題目內容可持續擴充

---

### [ ] **Task 3.3**: 計畫介面設計
- **Task Name**: 將每日修身改為類似得到 App 的計畫介面
- **Estimated completed time**: 12-16 小時 (可分為設計與實作兩階段)
- **Work Description**:
    - Why: 提升使用者體驗，讓每日學習更有計畫性和目標感，參考得到 App 的設計風格
    - How:
        1. **階段一 - 設計 (4-6 小時)**
           - 參考得到 App 介面設計
           - 使用 PPT/Figma 設計介面原型
           - 確認日曆檢視功能需求
           - 設計學習挑戰賽功能流程
        2. **階段二 - 實作 (8-10 小時)**
           - 實作新的計畫介面 UI
           - 整合日曆元件 (TaskCalendar 已存在)
           - 實作學習挑戰賽實際功能
           - 連接後端 API
- **Resources Required**:
    - Materials: 得到 App 介面參考、設計工具 (PPT/Figma)
    - Personnel: UI/UX 設計師 1 名、前端開發者 1 名
    - Reference Codes/docs:
        - `src/components/daily-tasks/TaskCalendar.tsx` - 現有日曆元件
        - `src/app/(main)/daily-tasks/page.tsx:698-802` - 現有挑戰賽 UI (placeholder)
        - 得到 App 參考截圖
- **Deliverables**:
    - [ ] UI/UX 設計原型 (PPT/Figma)
    - [ ] 新的計畫介面頁面
    - [ ] 日曆功能整合
    - [ ] 學習挑戰賽功能實作
    - [ ] 使用者測試與回饋
- **Dependencies**: Task 3.1, Task 3.2
- **Constraints**: 設計需先完成才能開始實作
- **Completion Status**: 未開始
- **Notes**: 這是較大的功能重構，建議分階段進行，11/25 前完成基礎版本

---

## Phase 4: 閱讀頁面功能修復

### [X] **Task 4.1**: AI 問答對話歷史保存
- **Task Name**: 修復重新打開 Toggle 視窗時對話內容消失的問題
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 重新打開 AI 問答 Toggle 視窗時，之前的對話內容會消失，需要再重新輸入送出 query 才會出現上次對話紀錄
    - How:
        1. 分析 `activeSessionMessages` 的狀態管理 (`src/app/(main)/read-book/page.tsx:2804`)
        2. 檢查 Sheet 開關時的狀態保持邏輯
        3. 實作對話歷史持久化 (localStorage 或 state 保持)
        4. 確保關閉再開啟時能正確載入歷史對話
- **Resources Required**:
    - Materials: 現有問答模組文檔
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:2804-2807` - activeSessionMessages
        - `src/components/ui/ConversationFlow.tsx` - 對話流程元件
        - `src/app/(main)/read-book/page.tsx:3504-3508` - ConversationFlow 使用
- **Deliverables**:
    - [ ] 對話歷史狀態保持機制
    - [ ] Toggle 開關時對話不消失
    - [ ] 可選：對話歷史持久化到 localStorage
    - [ ] 測試各種開關場景
- **Dependencies**: 無
- **Constraints**: 需考慮記憶體使用量
- **Completion Status**: 未開始
- **Notes**: 可能是 Sheet 元件的 unmount 行為導致

---

### [ ] **Task 4.2**: AI 問答回覆功能修復 (Perplexity)
- **Task Name**: 修復 Perplexity AI 問答模組的多項 UI/功能問題
- **Estimated completed time**: 6-8 小時
- **Work Description**:
    - Why: AI 問答區域存在多個問題（參見 `temp/perplexityAI_Bug/bug_2025_11_29.png`、`temp/perplexityAI_Bug/perplexityUi.jpg`）
    - **2025-11-30 回報問題 (新)**:
        1. **AI UI 完全無法顯示**: 點開 AI 按鈕後出現灰色畫面，沒有實際的 UI 元件（參見 `temp/perplexityAI_Bug/perplexityUi.jpg`）
        2. **AI 無法持續生成題目**: Console 錯誤 `q.getProgress is not a function` 導致功能失效
    - **2025-11-29 回報問題**:
        1. AI 回答顯示在「回到底部」按鈕之下（位置錯誤）
        2. 回答時僅顯示「正在深度思考」，不會 streaming 顯示內容
        3. Thinking tab 無法收合、無法 scrolling
        4. 無法看到正式輸出內容，回答只顯示一個「《」符號
    - How:
        1. 調整 AI 回覆訊息的 DOM 層級與定位
        2. 檢查 streaming 邏輯，確保內容即時顯示
        3. 修復 Thinking tab 的展開/收合與滾動功能
        4. 診斷回覆內容解析問題，確保完整顯示
- **Resources Required**:
    - Materials: `temp/perplexityAI_Bug/bug_2025_11_29.png` 錯誤截圖、Perplexity API 文檔
    - Personnel: 全端開發者 1 名
    - Reference Codes/docs:
        - `src/components/ui/ConversationFlow.tsx` - 對話流程元件
        - `src/components/ui/AIMessageBubble.tsx` - AI 訊息泡泡元件
        - `src/ai/flows/perplexity-red-chamber-qa.ts` - Perplexity 整合
        - `src/lib/perplexity-client.ts` - Perplexity 客戶端
- **Deliverables**:
    - [ ] 修復 AI 回覆顯示位置（在「回到底部」按鈕之上）
    - [ ] 實現 streaming 即時顯示功能
    - [ ] 修復 Thinking tab 收合/展開與滾動
    - [ ] 修復回覆內容完整顯示問題
- **Dependencies**: 無
- **Constraints**: 需要有效的 Perplexity API 金鑰
- **Completion Status**: ⚠️ **需重新修復** (2025-11-30 發現 UI 完全無法顯示的嚴重問題)
- **Notes**: 檢查 `.env.local` 中的 API 配置
- **歷史修復紀錄** (2025-11-21 - 第二版修復):
  - **問題根源**：Perplexity reasoning 模型回應格式複雜，答案可能在 `<think>` 標籤內或外。原本的 `cleanResponse` 函數簡單移除所有 `<think>` 標籤，導致如果答案在標籤內就會被全部移除。
  - **修復方案**（基於 Perplexity 官方建議："使用自定義 parser 提取有效內容"）：
    1. **新增智能解析方法** `parseReasoningResponse()` (perplexity-client.ts:248-289)
       - 正確分離 `<think>` 標籤內的推理過程和實際答案內容
       - 支持多種格式：答案在標籤外、答案在標籤內
       - 使用模式匹配自動分離思考和答案（當答案在標籤內時）
    2. **修改 streaming 處理邏輯** (perplexity-client.ts:644-673)
       - 使用新的 `parseReasoningResponse()` 方法解析內容
       - `aggregatedContent = answer || cleanResponse(fullContent)` 優先使用解析出的答案
       - 保留 `isComplete` 檢查，確保 fallback 只在真正需要時觸發
    3. **撤回第一版錯誤修改** (read-book/page.tsx)
       - 移除可能導致問題的客戶端 `continue` 邏輯
    4. **添加詳細日誌** (perplexity-client.ts:663-673)
       - 記錄原始內容長度、thinking 長度、answer 長度
       - 顯示是否包含 `<think>` 標籤、原始內容預覽
       - 便於診斷實際 API 回應格式
  - **關鍵改進**：
    - ✅ 符合 Perplexity 官方建議
    - ✅ 智能處理多種回應格式
    - ✅ 詳細日誌幫助診斷
    - ✅ 必須使用 reasoning 模型（保留推理功能）
  - **測試指令**：
    ```bash
    npm run typecheck  # 驗證 TypeScript
    npm run lint       # 驗證程式碼品質
    npm test -- tests/lib/perplexity-client.test.ts  # 執行單元測試
    npm run dev        # 啟動開發伺服器進行手動測試
    ```
  - **單元測試覆蓋** (tests/lib/perplexity-client.test.ts:883-1239):
    1. ✅ 處理單一網路 chunk 中的多個 SSE events
    2. ✅ 當第一個 event 有 finish_reason 時不會提前停止
    3. ✅ parseReasoningResponse 正確分離 thinking 和 answer（標籤外）
    4. ✅ parseReasoningResponse 正確分離 thinking 和 answer（標籤內）
    5. ✅ 處理大型單一網路 chunk（模擬 5248 字節）
    6. ✅ 記錄批次處理資訊的日誌
  - **驗證步驟**：
    1. 進入閱讀頁面 AI 問答模組
    2. 提交問題如「林黛玉的性格特點有哪些？」
    3. 確認不再顯示「⚠️ 系統僅收到 AI 的思考內容」
    4. 確認正確顯示完整的 AI 回答
    5. **檢查瀏覽器 Console 日誌**，查看詳細解析資訊（rawContentLength, thinkingLength, answerLength）
    6. 確認 thinking 內容正確顯示在思考面板

---

### [X] **Task 4.3**: 成就通知顯示優化
- **Task Name**: 成就只在首次觸發時顯示通知
- **Estimated completed time**: 2-3 小時
- **Work Description**:
    - Why: 目前成就如「心有疑，隨札記」會時時通知，應該只在首次觸發時顯示
    - How:
        1. 追蹤成就顯示狀態 (已通知/未通知)
        2. 在 localStorage 或資料庫記錄已顯示的成就
        3. 修改成就通知邏輯，只在首次觸發時顯示
        4. 確保重新登入後仍能正確判斷
- **Resources Required**:
    - Materials: 成就系統文檔
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx` - 成就觸發邏輯
        - `src/components/gamification/` - 遊戲化元件
- **Deliverables**:
    - [ ] 成就通知狀態追蹤機制
    - [ ] 修改通知顯示條件
    - [ ] 測試各種成就首次觸發場景
- **Dependencies**: 無
- **Constraints**: 無
- **Completion Status**: 未開始
- **Notes**: 可用 localStorage 快速實作

---

### [ ] **Task 4.4**: 補充章回內容至 20 回
- **Task Name**: 補充紅樓夢內容至第 20 回
- **Estimated completed time**: 8-12 小時 (主要為內容準備時間)
- **Work Description**:
    - Why: 目前只有第 1 回有完整內容，第 2-25 回只有示例段落 (`src/app/(main)/read-book/page.tsx:190-199`)
    - How:
        1. 準備第 2-20 回的原文與白話文內容
        2. 按照現有格式 (`Paragraph[]` 結構) 整理資料
        3. 添加必要的註釋 (annotations)
        4. 匯入 chapters_base_data
        5. 測試各章回顯示
- **Resources Required**:
    - Materials: 紅樓夢原文及白話文譯本
    - Personnel: 內容編輯 1 名、開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:163-199` - 章回資料結構
        - 第 1 回完整範例 (`src/app/(main)/read-book/page.tsx:164-188`)
- **Deliverables**:
    - [ ] 第 2-20 回原文內容
    - [ ] 第 2-20 回白話文翻譯
    - [ ] 重要詞句註釋
    - [ ] 資料匯入與格式驗證
    - [ ] 各章回顯示測試
- **Dependencies**: 無
- **Constraints**: 需要人工準備與校對內容，時間較長
- **Completion Status**: 未開始
- **Notes**: 這是內容工作，可與其他技術任務並行進行

---

### [ ] **Task 4.5**: 雙欄閱讀功能修復
- **Task Name**: 修復雙欄模式翻頁與視角問題
- **Estimated completed time**: 4-6 小時
- **Work Description**:
    - Why: 雙欄功能存在多個問題
    - **2025-11-29 回報問題**:
        1. 只能滑到下一頁，無法滑回上一頁
        2. 閱讀時視角會被上方的 tab 遮擋
        3. 此設計不符合 `D:\AboutCoding\SideProject\TextReader\githubRepo\epub.js` 的設計原則
    - How:
        1. 檢查分頁導航邏輯，確保支援前/後翻頁
        2. 調整閱讀區域的 CSS，避免被 header/tab 遮擋
        3. 參考 foliate-js 的分頁設計原則進行重構
        4. 實現平滑的翻頁動畫效果
        5. 測試不同螢幕尺寸與字體大小
- **Resources Required**:
    - Materials: `temp/biColumnUi/` 相關截圖、foliate-js 設計參考
    - Personnel: 前端開發者 1 名
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx:1050-1130` - 雙欄分頁邏輯
        - `src/app/(main)/read-book/page.tsx:222` - ColumnLayout 類型
        - `src/app/(main)/read-book/page.tsx:493` - columnLayout 狀態
        - `githubRepo/foliate-js` - 設計參考
- **Deliverables**:
    - [ ] 實現向前/向後翻頁功能
    - [ ] 修復視角被 tab 遮擋問題
    - [ ] 符合 foliate-js 設計原則
    - [ ] 不同螢幕尺寸測試
    - [ ] 字體大小變化測試
- **Dependencies**: 無
- **Constraints**: 需要處理多種裝置與螢幕尺寸，需參考 foliate-js
- **Completion Status**: ⚠️ **需重新修復** (2025-11-30 確認問題仍存在)
- **Notes**: 需參考 D:\AboutCoding\SideProject\TextReader\githubRepo\epub.js 的實作方式
- **2025-11-30 更新**: 使用者確認 bi-column 問題仍未解決

---

### [x] **Task 4.6**: Console 執行時錯誤修復 (多項)
- **Task Name**: 修復 Console 中的多項執行時錯誤
- **Estimated completed time**: 8-10 小時
- **新增日期**: 2025-11-29
- **最後更新**: 2025-11-30
- **Work Description**:
    - Why: Console 顯示多項錯誤，影響功能正常運作
    - **錯誤清單**:
        1. 已解決：**用戶 Profile 錯誤**: `Cannot read properties of undefined (reading 'getTime')` - 導致無法載入經驗值、等級資料
           ```
           Error fetching user profile: TypeError: Cannot read properties of undefined (reading 'getTime')
           at j.getUserProfile (.next/server/chunks/696.js:1:8531)
           ```
        2. **每日進度錯誤 (2025-11-30 確認仍存在)**: `q.getProgress is not a function` - 影響每日任務進度顯示，導致 AI 無法持續生成題目
           ```
           2025-11-30 07:44:59.481 [error] Error fetching daily progress: TypeError: q.getProgress is not a function
            at w.getUserDailyProgress (.next/server/chunks/9813.js:1:3931)
            at h (.next/server/app/api/daily-tasks/progress/route.js:1:6518)
            ai 無法生成題目
           ```
        3. 已解決：**OpenAI API 超時**: `fetch failed - connect ETIMEDOUT` - API 呼叫超時問題
           ```
           ⚠️ OpenAI API call timed out after 60000ms, using fallback
           [cause]: Error: connect ETIMEDOUT 57.182.53.221:443
           ```
        4. **經驗值問題**: AI 批改後 (明明是95分) 未成功加 EXP 經驗值
        5. **任務完成狀態**: 完成任務後介面未顯示標示為完成
    - How:
        1. **錯誤 1**: 檢查 `getUserProfile` 函數，修復 undefined 時間處理
        2. **錯誤 2**: 檢查 `getProgress` 方法定義，確保正確引用
        3. **錯誤 3**: 增加 API 超時處理與重試機制
        4. **錯誤 4**: 追蹤經驗值更新邏輯，修復寫入失敗問題
        5. **錯誤 5**: 修復任務完成狀態的 UI 更新
- **Resources Required**:
    - Reference Codes/docs:
        - `src/app/api/user/profile/route.ts` - 用戶 Profile API
        - `src/app/api/daily-tasks/progress/route.ts` - 每日進度 API
        - `src/lib/user-level-service.ts` - 用戶等級服務
- **Deliverables**:
    - [ ] 修復 `getTime` undefined 錯誤
    - [ ] 修復 `getProgress` 方法錯誤
    - [ ] 優化 OpenAI API 超時處理
    - [ ] 修復經驗值更新邏輯
    - [ ] 修復任務完成狀態顯示
- **Dependencies**: 無
- **Completion Status**: 未開始
- **Notes**: 多個錯誤可能互相關聯，建議逐一排查

---

### [x] **Task 4.7**: 登入後首頁顯示「尚未登入」問題
- **Task Name**: 修復登入後首頁仍顯示「尚未登入」的狀態
- **Estimated completed time**: 2-3 小時
- **新增日期**: 2025-11-29
- **Work Description**:
    - Why: 用戶登入後，首頁仍然顯示「尚未登入」，登入狀態未正確同步
    - How:
        1. 檢查 AuthContext 狀態管理邏輯
        2. 確認 session 狀態在頁面切換時的保持機制
        3. 修復狀態同步問題
        4. 測試各頁面登入狀態一致性
- **Resources Required**:
    - Reference Codes/docs:
        - `src/context/AuthContext.tsx` - 認證狀態管理
        - `src/app/page.tsx` - 首頁
- **Deliverables**:
    - [ ] 診斷狀態不同步根本原因
    - [ ] 修復登入狀態顯示問題
    - [ ] 各頁面狀態一致性測試
- **Dependencies**: 無
- **Completion Status**: 未開始

---

### [x] **Task 4.8**: 註冊帳號時允許輸入用戶名稱
- **Task Name**: 註冊時讓用戶自訂名稱，避免顯示數字編號
- **Estimated completed time**: 2-3 小時
- **新增日期**: 2025-11-29
- **Work Description**:
    - Why: 目前註冊帳號時無法讓用戶輸入名稱，導致用戶名稱顯示為數字 (000, 001, 002)，體驗不佳
    - How:
        1. 修改註冊表單 UI，新增「用戶名稱」輸入欄位
        2. 更新註冊 API 端點接收並儲存用戶名稱
        3. 新增用戶名稱驗證邏輯 (長度、字元限制)
        4. 設定預設值機制 (若用戶不輸入則生成預設名稱)
- **Resources Required**:
    - Reference Codes/docs:
        - `src/app/api/auth/register/route.ts` - 註冊 API
        - 相關註冊表單元件
- **Deliverables**:
    - [ ] 註冊表單新增「用戶名稱」欄位
    - [ ] API 支援儲存用戶名稱
    - [ ] 驗證與錯誤處理
- **Dependencies**: 無
- **Completion Status**: 未開始

---

### [ ] **Task 4.9**: 紅學社筆記編輯後分享內容未同步更新
- **Task Name**: 修復閱讀筆記編輯後紅學社分享內容不同步問題
- **Estimated completed time**: 3-4 小時
- **新增日期**: 2025-11-29
- **Work Description**:
    - Why: 當閱讀筆記有編輯更新後，紅學社顯示的分享筆記不會同時被更新。此外，被更新的發文應在發布時間旁顯示「已編輯」標記
    - How:
        1. 檢查筆記更新時是否同步更新紅學社分享內容
        2. 建立筆記與社群貼文的關聯機制
        3. 實作「已編輯」標記顯示邏輯
        4. 在發布時間旁顯示「已編輯」文字
- **Resources Required**:
    - Reference Codes/docs:
        - `src/lib/repositories/` - 筆記與社群資料存取
        - `src/app/(main)/community/` - 紅學社頁面
        - `src/components/community/` - 社群相關元件
- **Deliverables**:
    - [ ] 筆記編輯後同步更新紅學社分享內容
    - [ ] 新增「已編輯」標記欄位與顯示
    - [ ] 發布時間旁顯示「已編輯」文字
    - [ ] 測試編輯同步功能
- **Dependencies**: 無
- **Completion Status**: 未開始

---

### [ ] **Task 4.10**: 閱讀頁面筆記公開分享未出現在紅學社
- **Task Name**: 修復閱讀頁面公開分享筆記未顯示在紅學社的問題
- **Estimated completed time**: 3-4 小時
- **新增日期**: 2025-11-30
- **Work Description**:
    - Why: 在閱讀頁面做筆記並設為公開內容後，切換到紅學社頁面並沒有出現該公開分享的筆記文。這與 Task 4.9 (編輯後不同步) 是不同的問題 - 這是**新分享的筆記完全不出現**
    - How:
        1. 檢查閱讀頁面「公開分享」功能是否正確呼叫社群 API
        2. 確認筆記的 `isPublic` 狀態是否正確寫入資料庫
        3. 檢查紅學社頁面查詢公開筆記的 API 邏輯
        4. 驗證筆記與社群貼文的資料關聯是否正確建立
        5. 測試完整流程：建立筆記 → 設為公開 → 紅學社顯示
- **Resources Required**:
    - Reference Codes/docs:
        - `src/app/(main)/read-book/page.tsx` - 閱讀頁面筆記功能
        - `src/lib/repositories/note-repository.ts` - 筆記資料存取
        - `src/lib/repositories/community-repository.ts` - 社群資料存取
        - `src/app/(main)/community/page.tsx` - 紅學社頁面
        - `src/app/api/community/posts/route.ts` - 社群貼文 API
- **Deliverables**:
    - [ ] 診斷公開分享筆記未出現的根本原因
    - [ ] 修復筆記公開分享到紅學社的流程
    - [ ] 確保新分享的筆記即時出現在紅學社
    - [ ] 測試完整的分享與顯示流程
- **Dependencies**: 無
- **Completion Status**: 未開始
- **Notes**: 此問題與 Task 4.9 (編輯後同步) 可能有相關，但需分別處理

---

## 工作優先順序建議
**初始修復先給claude，再不行再給codex

### 高優先 (2025-11-30 更新)
1. **Task 4.6** - Console 執行時錯誤修復 (影響多項核心功能，包含 `getProgress` 錯誤)
2. **Task 4.2** - AI 問答回覆功能修復 (2025-11-30 發現 UI 完全無法顯示) - ⚠️ **需重新修復**
3. **Task 4.5** - 雙欄閱讀功能修復 (2025-11-30 確認仍未解決) - ⚠️ **需重新修復**
4. **Task 4.10** - 閱讀頁面筆記公開分享未出現在紅學社 - **新增 2025-11-30**

### 已修復完成
- **Task 4.1** - AI 問答對話歷史保存 - 修復完成
- **Task 4.7** - 登入後首頁顯示「尚未登入」
- **Task 4.8** - 註冊帳號時允許輸入用戶名稱
- **Task 4.9** - 紅學社筆記編輯後分享內容未同步更新
- **Task 3.1** - 任務顯示 Bug 修復 - 修復完成
- **Task 1.3** - 主頁 UI 佈局修復 - 修復完成
- **Task 1.1** - 頁面編譯效能優化 - 修復完成
- **Task 1.2** - Loading 動畫效果修復 - 修復完成
- **Task 4.3** - 成就通知顯示優化 - 修復完成

### 可延後 (時間允許再處理)
9. **Task 2.2** - 學習進度總覽動態數據
10. **Task 2.1** - 虛擬居所功能實作
11. **Task 3.2** - 預生成題目系統
12. **Task 4.4** - 補充章回內容至 20 回
13. **Task 3.3** - 計畫介面設計

---

## 時間估算總覽

| Phase | 預估時間 | 說明 |
|-------|----------|------|
| Phase 1 | 9-13 小時 | 系統基礎與效能 |
| Phase 2 | 14-20 小時 | 成就與遊戲化 |
| Phase 3 | 24-32 小時 | 每日修身系統 |
| Phase 4 | 24-35 小時 | 閱讀頁面功能 |
| Phase 5 | 4-5 小時 | **Vercel 雲端部署** ⭐ (原 Azure 需 20-31 小時) |
| **總計** | **75-105 小時** | (原 Azure 方案: 91-131 小時) |

**建議**：
- 每日工作 8 小時，5 天共 40 小時
- 優先完成高優先任務 (約 18-26 小時)
- 中優先任務 (約 15-22 小時)
- **Phase 5 部署**: 僅需 1 個工作天 (4-5 小時) ⚡
- 剩餘時間處理低優先任務

**Vercel 部署優勢**:
- 時間節省 80% (從 20-31 小時減至 4-5 小時)
- 零配置 CI/CD (push 即自動部署)
- Next.js 15 原生優化支援
- 免費層足夠 MVP 階段使用

---

## 風險與備註

1. **內容準備風險**：Task 4.4 (補充章回) 和 Task 3.2 (預生成題目) 需要大量人工內容準備，可能超出預估時間
2. **API 配置風險**：Task 4.2 需要確認 Perplexity API 配置正確
3. **設計依賴**：Task 3.3 需要先完成設計原型才能開始實作
4. **測試時間**：每個任務完成後需要預留測試時間

**建議進行每日 Stand-up**：追蹤進度並及時調整優先順序

---

## Phase 5: Vercel 雲端部署上線

> **部署平台變更**: 原計畫使用 Azure，現改為 **Vercel** 以獲得更佳的 Next.js 15 支援與更快的部署流程

### [x] **Task 5.1**: 資料庫遷移至 Turso (LibSQL)
- **Task Name**: 將 SQLite 遷移至 Turso 雲端資料庫
- **Estimated completed time**: 2-3 小時
- **Work Description**:
    - Why: Vercel 的 serverless 架構無法使用 file-based SQLite (`better-sqlite3`)，必須遷移至雲端資料庫。選擇 Turso 因為其 SQLite 語法相容性高 (95% 程式碼不需改動)，且免費層充足
    - How:
        1. **Turso 帳號建立與資料庫設定 (15 分鐘)**:
           - 前往 [turso.tech](https://turso.tech) 註冊免費帳號
           - 安裝 Turso CLI: `curl -sSfL https://get.tur.so/install.sh | bash`
           - 登入: `turso auth login`
           - 建立生產資料庫: `turso db create redmansion-prod`
           - 取得連線資訊: `turso db show redmansion-prod`
           - 生成 auth token: `turso db tokens create redmansion-prod`
        2. **安裝 libSQL 客戶端 (5 分鐘)**:
           ```bash
           npm install @libsql/client
           npm uninstall better-sqlite3  # 移除舊的 SQLite 套件
           ```
        3. **修改資料庫連線層 (1.5-2 小時)**:
           - 更新 `src/lib/sqlite-db.ts`:
             ```typescript
             // 從 better-sqlite3:
             import Database from 'better-sqlite3';
             const db = new Database(path);

             // 改為 libSQL:
             import { createClient } from '@libsql/client';
             const db = createClient({
               url: process.env.TURSO_DATABASE_URL!,
               authToken: process.env.TURSO_AUTH_TOKEN!,
             });
             ```
           - 修改查詢語法 (大部分不需改動，僅需將同步 API 改為異步):
             - `db.prepare().get()` → `await db.execute()`
             - `db.prepare().all()` → `await db.execute()`
             - `db.prepare().run()` → `await db.execute()`
           - 更新 `src/lib/repositories/` 下所有 repository 檔案的查詢方法
        4. **本地測試驗證 (30 分鐘)**:
           - 在 `.env.local` 新增 Turso 環境變數
           - 執行資料庫初始化腳本 (如需要)
           - 測試所有關鍵資料庫操作:
             - 使用者註冊/登入
             - 每日任務生成
             - 社群貼文建立/查詢
             - 筆記儲存/讀取
- **Resources Required**:
    - Materials: Turso 官方文檔、libSQL TypeScript SDK 文檔
    - Personnel: 後端開發者 1 名
    - Reference Codes/docs:
        - `src/lib/sqlite-db.ts` - 資料庫初始化
        - `src/lib/repositories/` - 所有資料存取邏輯
        - [Turso + Next.js 官方指南](https://docs.turso.tech/sdk/ts/guides/nextjs)
        - [libSQL Client API 文檔](https://docs.turso.tech/sdk/ts/reference)
- **Deliverables**:
    - [ ] Turso 帳號與生產資料庫建立完成
    - [ ] `@libsql/client` 已安裝，`better-sqlite3` 已移除
    - [ ] `src/lib/sqlite-db.ts` 改用 libSQL client
    - [ ] 所有 repository 查詢方法改為異步
    - [ ] `.env.local.example` 新增 Turso 環境變數範例
    - [ ] 本地測試通過 (所有資料庫功能正常)
- **Dependencies**: 無
- **Constraints**:
    - 需要將同步程式碼改為異步 (async/await)
    - Turso 免費層限制: 500 MB 儲存、1 億次 row reads/月
- **Completion Status**: 未開始
- **Notes**:
    - **資料遷移**: 如需保留現有 SQLite 資料，可使用 `turso db shell` 匯入 SQL dump
    - **備份機制**: Turso 提供自動備份功能，可在 dashboard 設定

---

### [x] **Task 5.2**: Vercel 環境變數配置
- **Task Name**: 配置 Vercel 部署所需的所有環境變數
- **Estimated completed time**: 45 分鐘
- **Work Description**:
    - Why: 確保所有 API 金鑰、資料庫連線與 NextAuth 設定在 Vercel 生產環境正確運作
    - How:
        1. **準備環境變數清單 (15 分鐘)**:
           建立 `.env.vercel` 文檔記錄所有變數 (不提交至 git):
           ```env
           # Database (Turso)
           TURSO_DATABASE_URL=libsql://redmansion-prod-[username].turso.io
           TURSO_AUTH_TOKEN=eyJhbGciOiJFZENTQSIsInR5cCI6IkpXVCJ9...

           # AI APIs
           OPENAI_API_KEY=sk-proj-...
           PERPLEXITYAI_API_KEY=pplx-...
           OPENAI_MODEL=gpt-5-mini

           # Authentication (NextAuth.js)
           NEXTAUTH_SECRET=[使用 openssl rand -base64 32 生成]
           NEXTAUTH_URL=https://your-app.vercel.app

           # Cron Jobs
           CRON_SECRET=[自訂密鑰，用於保護 cron 端點]

           # Debug (生產環境應設為 false)
           DEBUG_OPENAI=false
           ```
        2. **生成生產環境密鑰 (10 分鐘)**:
           ```bash
           # 生成 NextAuth secret (32 字元 base64)
           openssl rand -base64 32

           # 生成 Cron secret (可用相同方法或自訂)
           openssl rand -base64 24
           ```
        3. **在 Vercel Dashboard 設定環境變數 (15 分鐘)**:
           - 登入 [Vercel Dashboard](https://vercel.com)
           - 選擇專案 → Settings → Environment Variables
           - 逐一新增所有環境變數
           - **重要**: 選擇 `Production` 環境 (不要用 Development)
           - 敏感資訊 (API keys, tokens) 勾選 "Sensitive" 選項
        4. **更新 `.env.local.example` (5 分鐘)**:
           建立範例檔案供團隊參考 (不包含實際值):
           ```env
           # Database
           TURSO_DATABASE_URL=your_turso_database_url
           TURSO_AUTH_TOKEN=your_turso_auth_token

           # AI APIs
           OPENAI_API_KEY=your_openai_api_key
           PERPLEXITYAI_API_KEY=your_perplexity_api_key

           # Authentication
           NEXTAUTH_SECRET=your_nextauth_secret
           NEXTAUTH_URL=http://localhost:3000
           ```
- **Resources Required**:
    - Materials: Turso 連線資訊 (從 Task 5.1)、現有 API 金鑰
    - Personnel: 開發者 1 名
    - Reference Codes/docs:
        - `src/lib/env.ts` - 環境變數驗證 schema
        - [Vercel 環境變數文檔](https://vercel.com/docs/projects/environment-variables)
- **Deliverables**:
    - [ ] `.env.vercel` 文檔建立 (本地保存，不提交)
    - [ ] 生產環境 `NEXTAUTH_SECRET` 已生成
    - [ ] Vercel Dashboard 所有環境變數已設定
    - [ ] `.env.local.example` 已更新
    - [ ] `.gitignore` 確認包含 `.env.*` (除了 `.env.local.example`)
- **Dependencies**: Task 5.1 (需要 Turso 連線資訊)
- **Constraints**:
    - 絕對不可將 `.env.local` 或 `.env.vercel` 提交至 git
    - `NEXTAUTH_URL` 必須是 Vercel 部署的實際網址
- **Completion Status**: 未開始
- **Notes**:
    - Vercel 會在部署時自動載入環境變數
    - 修改環境變數後需重新部署才會生效

---

### [x] **Task 5.3**: Vercel 部署與驗證
- **Task Name**: 連接 GitHub 並完成首次 Vercel 部署與功能測試
- **Estimated completed time**: 1-1.5 小時
- **Work Description**:
    - Why: 確保應用程式在 Vercel 生產環境正常運作，所有核心功能可用
    - How:
        1. **本地建置驗證 (15 分鐘)**:
           ```bash
           # 確保本地建置成功
           npm run typecheck  # TypeScript 類型檢查
           npm run lint       # ESLint 程式碼檢查
           npm test           # 執行測試套件 (71 tests)
           npm run build      # 生產建置
           ```
           - 如有錯誤，先修復後再繼續
        2. **連接 GitHub 到 Vercel (10 分鐘)**:
           - 登入 [Vercel Dashboard](https://vercel.com)
           - 點選 "Add New..." → "Project"
           - 選擇 GitHub repository (需授權 Vercel 存取)
           - 選擇 `master` 或 `main` 分支作為生產分支
           - Framework Preset: 自動偵測為 "Next.js"
           - Build Settings: 使用預設值
           - 點選 "Deploy" 開始首次部署
        3. **監控部署狀態 (5-10 分鐘)**:
           - 查看 Vercel 部署 logs
           - 確認建置成功 (Status: Ready)
           - 記下生產網址 (如: `https://redmansion.vercel.app`)
        4. **功能測試驗證 (30-45 分鐘)**:
           - **基礎測試**:
             - [ ] 首頁正常載入 (無 500 錯誤)
             - [ ] 靜態資源載入正常 (圖片、CSS)
             - [ ] 頁面路由正常 (點擊導覽連結)
           - **核心功能測試**:
             - [ ] 使用者註冊流程 (POST `/api/auth/register`)
             - [ ] 使用者登入流程 (NextAuth.js)
             - [ ] 閱讀頁面載入與 AI 問答
             - [ ] 每日任務生成 (POST `/api/daily-tasks/generate`)
             - [ ] 社群貼文查詢 (GET `/api/community/posts`)
             - [ ] 筆記儲存功能
           - **資料庫驗證**:
             - [ ] 註冊新使用者後確認資料寫入 Turso
             - [ ] 登入時確認能正確查詢使用者資料
             - [ ] 測試資料查詢效能 (回應時間 < 500ms)
           - **Cron Job 驗證** (選擇性):
             - [ ] 確認 `/api/cron/reset-daily-tasks` 端點可呼叫
             - [ ] 測試 cron secret 驗證功能
        5. **設定自動部署 (已內建)**:
           - Vercel 自動監聽 GitHub `main`/`master` 分支
           - 每次 push 程式碼即自動觸發部署
           - 無需額外設定 GitHub Actions
- **Resources Required**:
    - Materials: GitHub repository、Vercel 帳號
    - Personnel: 開發者 1 名、QA 測試人員 1 名 (選擇性)
    - Reference Codes/docs:
        - `package.json:6-14` - 建置與測試腳本
        - `next.config.ts` - Next.js 配置 (已相容 Vercel)
        - [Vercel 部署文檔](https://vercel.com/docs/deployments/overview)
- **Deliverables**:
    - [ ] 本地建置測試通過 (typecheck + lint + test + build)
    - [ ] GitHub repository 已連接至 Vercel
    - [ ] 首次部署成功 (Status: Ready)
    - [ ] 生產網址可正常存取
    - [ ] 所有核心功能測試通過
    - [ ] 資料庫讀寫驗證成功
    - [ ] 已知問題清單 (如有)
- **Dependencies**: Task 5.1 (資料庫遷移), Task 5.2 (環境變數)
- **Constraints**:
    - Vercel 免費層限制: 100 GB 頻寬/月、6000 分鐘建置時間
    - 部署失敗需查看 Vercel logs 診斷
- **Completion Status**: 未開始
- **Notes**:
    - **自動部署**: 推送至 `main` 即自動部署，無需手動觸發
    - **預覽部署**: Pull Request 會自動建立預覽環境
    - **監控**: Vercel 提供內建 Analytics (需升級 Pro 方案)

**生產環境檢查清單**:
```markdown
## 部署前檢查
- [ ] 本地 `npm run build` 成功
- [ ] 所有測試通過 (`npm test`)
- [ ] Vercel 環境變數已設定
- [ ] `NEXTAUTH_URL` 指向 Vercel 網址

## 部署後驗證
- [ ] 首頁載入成功 (200 status)
- [ ] 使用者註冊/登入正常
- [ ] AI 問答功能正常 (OpenAI + Perplexity)
- [ ] Turso 資料庫讀寫正常
- [ ] 每日任務生成功能正常
- [ ] 社群功能正常 (發文、留言)
```

---

## Phase 5 優先順序與時間規劃

### 部署任務順序 (必須依序執行)
1. **Task 5.1** - 資料庫遷移 (Turso) - 2-3 小時
2. **Task 5.2** - 環境變數配置 - 45 分鐘
3. **Task 5.3** - Vercel 部署與驗證 - 1-1.5 小時

### 時間估算
| Task | 預估時間 | 關鍵程度 | 依賴關係 |
|------|----------|----------|----------|
| Task 5.1 | 2-3 小時 | 🔴 必須 | 無 |
| Task 5.2 | 45 分鐘 | 🔴 必須 | Task 5.1 |
| Task 5.3 | 1-1.5 小時 | 🔴 必須 | Task 5.1, 5.2 |
| **總計** | **4-5 小時** | 可在 1 工作天內完成 |

### Vercel vs Azure 時間對比
- **原 Azure 方案**: 20-31 小時 (5 個 tasks)
- **新 Vercel 方案**: 4-5 小時 (3 個 tasks)
- **時間節省**: 約 **80%** (16-26 小時)

### 部署風險評估

1. **資料庫遷移風險** (中):
   - **風險**: 同步 API 改為異步可能影響現有程式碼
   - **緩解**: 大部分查詢語法相容，主要是加入 `await` 關鍵字
   - **備用方案**: 保留本地 SQLite 作為開發環境，僅生產環境用 Turso

2. **API 配額風險** (低):
   - **風險**: OpenAI/Perplexity API 可能超出免費配額
   - **緩解**: 在 Vercel 設定用量監控，API 提供商設定預算告警
   - **備用方案**: 升級 API 方案或限制功能使用頻率

3. **效能風險** (低):
   - **風險**: Turso 雲端查詢可能比本地 SQLite 慢
   - **緩解**: Turso 提供全球 edge replication，延遲通常 < 100ms
   - **備用方案**: 啟用 Turso 的 edge caching 功能

4. **成本風險** (極低):
   - **風險**: 超出 Vercel/Turso 免費層限制
   - **緩解**:
     - Vercel 免費層: 100 GB 頻寬/月 (足夠小型應用)
     - Turso 免費層: 1 億次 row reads/月 (足夠大部分場景)
   - **備用方案**: 升級至付費方案 (Vercel Hobby $20/月, Turso Starter $5/月)

### 建議部署策略

**快速上線方案** (✅ 推薦，適合 11/25 前上線):
- **資料庫**: Turso LibSQL (免費層)
- **部署平台**: Vercel (免費層)
- **CI/CD**: Vercel 內建自動部署 (無需設定)
- **監控**: Vercel Analytics (基礎版免費)
- **預估時間**: **4-5 小時**
- **優勢**:
  - 零配置 CI/CD (push 即部署)
  - Next.js 15 原生優化
  - 全球 CDN 與 edge functions
  - 免費層足夠 MVP 階段使用

**進階優化方案** (未來擴展使用):
- **資料庫**: Turso Starter ($5/月) - 更高效能與儲存
- **部署平台**: Vercel Pro ($20/月) - 進階 Analytics 與優先支援
- **監控**: Vercel Web Analytics + Sentry 錯誤追蹤
- **CDN**: Vercel Edge Network (內建)
- **適用時機**: 月活躍用戶 > 1000 人或需要進階功能時
